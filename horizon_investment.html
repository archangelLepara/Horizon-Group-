<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horizon Investment Consultants</title>
  <link rel="stylesheet" href="style/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <header class="header">
    <h1>Horizon Investment Consultants</h1>
    <p>Expert Guidance. Smart Decisions. Sustainable Growth.</p>
  </header>

  <!-- Services Section -->
  <section class="section services">
    <div class="service-card">
      <h2>Introduction to Stocks</h2>
      <p>Learn the basics of stock investing. <strong>Page under construction â€“ Available Soon!</strong></p>
    </div>
    <div class="service-card">
      <h2>MSE Portfolio Tracker</h2>
      <p>Manage your stock portfolio with Google login.</p>
      <button id="loginBtn">Login with Google</button>
      <button id="logoutBtn" style="display:none;">Logout</button>
    </div>
  </section>

  <!-- Portfolio Tracker Section -->
  <section class="section" id="portfolioSection" style="display:none;">
    <form id="stockForm">
      <h2>Add New Stock</h2>
      <input type="text" id="company" placeholder="Company Name" required>
      <input type="date" id="dateBought" required>
      <input type="number" id="quantity" placeholder="Quantity" min="1" required>
      <input type="number" id="price" placeholder="Price per Share" step="0.01" min="0" required>
      <button type="submit">Add Stock</button>
    </form>

    <h2>Your Portfolio</h2>
    <table id="portfolioTable">
      <thead>
        <tr>
          <th>Company</th>
          <th>Date Bought</th>
          <th>Quantity</th>
          <th>Price per Share</th>
          <th>Total Value</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Portfolio Performance</h2>
    <canvas id="portfolioChart" width="400" height="200"></canvas>
  </section>

  <!-- Firebase + Portfolio JS -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";
    
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCZtiRNOjxM875GzxcDB_cUROyVScH_OHA",
      authDomain: "horizon-investments.firebaseapp.com",
      projectId: "horizon-investments",
      storageBucket: "horizon-investments.firebasestorage.app",
      messagingSenderId: "453178632734",
      appId: "1:453178632734:web:e4e062c1a7a13829485c0f",
      measurementId: "G-GQWQ400WBH"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    // DOM Elements
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const portfolioSection = document.getElementById("portfolioSection");
    const stockForm = document.getElementById("stockForm");
    const portfolioTableBody = document.querySelector("#portfolioTable tbody");
    const portfolioChartCanvas = document.getElementById("portfolioChart").getContext("2d");

    let user = null;
    let chart = null;

    // Login
    loginBtn.addEventListener("click", async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        user = result.user;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        portfolioSection.style.display = "block";
        loadPortfolio();
      } catch (error) {
        alert("Login failed: " + error.message);
      }
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      user = null;
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      portfolioSection.style.display = "none";
    });

    // Auth state change
    onAuthStateChanged(auth, (u) => {
      if (u) {
        user = u;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        portfolioSection.style.display = "block";
        loadPortfolio();
      } else {
        user = null;
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        portfolioSection.style.display = "none";
      }
    });

    // Add stock
    stockForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const stock = {
        company: document.getElementById("company").value,
        dateBought: document.getElementById("dateBought").value,
        quantity: parseInt(document.getElementById("quantity").value),
        price: parseFloat(document.getElementById("price").value),
        uid: user.uid
      };
      await addDoc(collection(db, "portfolios"), stock);
      stockForm.reset();
      loadPortfolio();
    });

    // Load portfolio
    async function loadPortfolio() {
      const q = query(collection(db, "portfolios"), where("uid", "==", user.uid));
      const snapshot = await getDocs(q);
      const stocks = snapshot.docs.map(doc => doc.data());

      // Populate table
      portfolioTableBody.innerHTML = "";
      stocks.forEach(stock => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${stock.company}</td>
          <td>${stock.dateBought}</td>
          <td>${stock.quantity}</td>
          <td>${stock.price.toFixed(2)}</td>
          <td>${(stock.quantity * stock.price).toFixed(2)}</td>
        `;
        portfolioTableBody.appendChild(row);
      });

      // Draw chart
      const labels = stocks.map(s => s.company);
      const data = stocks.map(s => s.quantity * s.price);

      if (chart) chart.destroy();
      chart = new Chart(portfolioChartCanvas, {
        type: "bar",
        data: { labels, datasets: [{ label: "Total Value", data, backgroundColor: "#4caf50" }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }
  </script>

</body>
</html>
